{
  "url": "https://api.github.com/repos/matomo-org/matomo/issues/17202",
  "repository_url": "https://api.github.com/repos/matomo-org/matomo",
  "labels_url": "https://api.github.com/repos/matomo-org/matomo/issues/17202/labels{/name}",
  "comments_url": "https://api.github.com/repos/matomo-org/matomo/issues/17202/comments",
  "events_url": "https://api.github.com/repos/matomo-org/matomo/issues/17202/events",
  "html_url": "https://github.com/matomo-org/matomo/issues/17202",
  "id": 803048581,
  "node_id": "MDU6SXNzdWU4MDMwNDg1ODE=",
  "number": 17202,
  "title": "Matomo can be tricked to record spoofed X-Forwarded-For IPs",
  "user": {
    "login": "timdream",
    "id": 93093,
    "node_id": "MDQ6VXNlcjkzMDkz",
    "avatar_url": "https://avatars.githubusercontent.com/u/93093?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/timdream",
    "html_url": "https://github.com/timdream",
    "followers_url": "https://api.github.com/users/timdream/followers",
    "following_url": "https://api.github.com/users/timdream/following{/other_user}",
    "gists_url": "https://api.github.com/users/timdream/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/timdream/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/timdream/subscriptions",
    "organizations_url": "https://api.github.com/users/timdream/orgs",
    "repos_url": "https://api.github.com/users/timdream/repos",
    "events_url": "https://api.github.com/users/timdream/events{/privacy}",
    "received_events_url": "https://api.github.com/users/timdream/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 112370581,
      "node_id": "MDU6TGFiZWwxMTIzNzA1ODE=",
      "url": "https://api.github.com/repos/matomo-org/matomo/labels/c:%20Security",
      "name": "c: Security",
      "color": "fad8c7",
      "default": false,
      "description": "For issues that make Matomo more secure. Please report issues through HackerOne and not in Github."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/matomo-org/matomo/milestones/134",
    "html_url": "https://github.com/matomo-org/matomo/milestone/134",
    "labels_url": "https://api.github.com/repos/matomo-org/matomo/milestones/134/labels",
    "id": 5099423,
    "node_id": "MDk6TWlsZXN0b25lNTA5OTQyMw==",
    "number": 134,
    "title": "5.0.0",
    "description": "",
    "creator": {
      "login": "tsteur",
      "id": 273120,
      "node_id": "MDQ6VXNlcjI3MzEyMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/273120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tsteur",
      "html_url": "https://github.com/tsteur",
      "followers_url": "https://api.github.com/users/tsteur/followers",
      "following_url": "https://api.github.com/users/tsteur/following{/other_user}",
      "gists_url": "https://api.github.com/users/tsteur/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tsteur/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tsteur/subscriptions",
      "organizations_url": "https://api.github.com/users/tsteur/orgs",
      "repos_url": "https://api.github.com/users/tsteur/repos",
      "events_url": "https://api.github.com/users/tsteur/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tsteur/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 28,
    "closed_issues": 49,
    "state": "open",
    "created_at": "2020-02-12T19:41:40Z",
    "updated_at": "2022-09-30T00:23:49Z",
    "due_on": "2022-05-18T07:00:00Z",
    "closed_at": null
  },
  "comments": 10,
  "created_at": "2021-02-07T20:26:42Z",
  "updated_at": "2022-07-08T02:34:39Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Problem\r\n\r\nConsidering the current implementation: https://github.com/matomo-org/matomo/blob/a31fd86b64c2c7d2deadcfca71540fb4b0152c10/core/IP.php#L99-L125\r\n\r\nWith the following setup:\r\n\r\n```\r\n[client] -> [reverse proxy 1] -> [reverse proxy 2] -> [matomo Nginx]\r\n```\r\n\r\nSince each proxy appends the IP of the incoming connection according to [RFC7239](https://tools.ietf.org/html/rfc7239), `X-Forwarded-For` will be this by the time the connection reaches Nginx (1):\r\n\r\n```\r\nX-Forwarded-For: (client), (proxy 1)\r\n```\r\n\r\nMatomo currently extracts the first IP from the list, since #10404. This is correct until you realized the \"client\" can pretended to be a proxy as well, by including its own `X-Forwarded-For` header, like this:\r\n\r\n```shell\r\ncurl -i -H\"X-Forwarded-For: 8.8.8.8\" \"http://example.com/matomo/matomo.php?...\"\r\n```\r\n\r\nWhen this happens, proxy 1 will be faithfully preserve the header passed in and append the client IP after it (2):\r\n\r\n```\r\nX-Forwarded-For: 8.8.8.8, (client), (proxy 1)\r\n```\r\n\r\nAnd Matomo will extract `8.8.8.8` as the client IP.\r\n\r\n## Solutions\r\n\r\n### Solution 1: Trust the \"transparent proxies\"\r\n\r\nIf Matomo decided the first \"client\" IP can always be trusted, we can still extract the first IP address, and this issue can be closed as \"works as intended.\" But it will in risk of having the analytics data being polluted. **Brutal force login detection can be tricked too.**\r\n\r\n### Solution 2: Extract the last IP address\r\n\r\nThis would involve reverting #10404 and go back to extract the last IP address. Since the original `proxy_ips[]` configuration is still intact, when facing a header like (2), above, a correctly configured Matomo will be able to exclude the \"proxy 1\" IP address.\r\n\r\n## Notes\r\n\r\n* There can be a solution 1.1 where Mamoto will rely on proxy 1 (the first public-facing proxy) to remove the spoofed header. However this is not always possible (not possible for Apache AFAIK)\r\n* It is unclear to me what other client IP headers (`HTTP_CF_CONNECTING_IP`, `HTTP_CLIENT_IP`, etc) behaves and if Matomo have to do things differently between these and the `X-Forwarded-For` header.\r\n* #7060 is a staled discussion related to this, but the discussion talks about the header processing in the context before #10342.\r\n* #16379 have since promoted `proxy_ips[]` pretty well in the documentation. We may consider doubling down on the documentation effort when we pick either solution for this issue.\r\n* Lastly, one tiny nitpick: #10404 updated the name of the function `IP::getFirstIpFromList` but it didn't change the word \"last\" in the function comment right above it :)\r\n\r\nThanks!",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/matomo-org/matomo/issues/17202/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/matomo-org/matomo/issues/17202/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
